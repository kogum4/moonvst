name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  discover-products:
    runs-on: ubuntu-latest
    outputs:
      products: ${{ steps.discover.outputs.products }}
      default_product: ${{ steps.discover.outputs.default_product }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        shell: bash
        run: |
          products_json="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.length===0){throw new Error('no products found under products/');}process.stdout.write(JSON.stringify(dirs));")"
          default_product="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.includes('template')){process.stdout.write('template');}else{process.stdout.write(dirs[0]);}")"
          echo "products=$products_json" >> "$GITHUB_OUTPUT"
          echo "default_product=$default_product" >> "$GITHUB_OUTPUT"
          echo "Discovered products: $products_json"

  build-macos:
    runs-on: macos-14
    needs: discover-products
    env:
      MACOS_CERT_P12_B64: ${{ secrets.MACOS_CERT_P12_B64 }}
      MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
      MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
      MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run macOS setup script
        run: bash scripts/setup-macos.sh

      - name: Import macOS signing certificate
        if: env.MACOS_CERT_P12_B64 != '' && env.MACOS_CERT_PASSWORD != '' && env.MACOS_SIGN_IDENTITY != '' && env.MACOS_KEYCHAIN_PASSWORD != ''
        shell: bash
        run: |
          set -euo pipefail
          CERT_PATH="$RUNNER_TEMP/macos-signing.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          echo "$MACOS_CERT_P12_B64" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Build all products
        shell: bash
        run: |
          set -euo pipefail
          products='${{ needs.discover-products.outputs.products }}'
          mkdir -p ci-artifacts
          for product in $(node -e "const p=JSON.parse(process.argv[1]);console.log(p.join(' '));" "$products"); do
            echo "=== Building product: $product ==="
            target_suffix="${product//-/_}"

            if [ "$product" = "template" ]; then
              npm run build:dsp
              npm run build:ui
            else
              npm run "build:dsp:$product"
              npm run "build:ui:$product"
            fi

            cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON -DMOONVST_PRODUCT="$product"
            npm run build:plugin
            artefacts_root="build/plugin/MoonVST_${target_suffix}_artefacts/Release"

            if [ -n "${MACOS_SIGN_IDENTITY:-}" ]; then
              for bundle in \
                "$artefacts_root/VST3/${product}.vst3" \
                "$artefacts_root/Standalone/${product}.app" \
                "$artefacts_root/AU/${product}.component"; do
                if [ -d "$bundle" ]; then
                  codesign --force --deep --options runtime --timestamp --sign "$MACOS_SIGN_IDENTITY" "$bundle"
                  codesign --verify --deep --strict --verbose=2 "$bundle"
                fi
              done
            fi

            product_dir="ci-artifacts/$product"
            mkdir -p "$product_dir/plugin" "$product_dir/tests"
            cp -R "$artefacts_root/VST3" "$product_dir/plugin/VST3"
            cp -R "$artefacts_root/Standalone" "$product_dir/plugin/Standalone"
            cp -R "$artefacts_root/Unity" "$product_dir/plugin/Unity"
            if [ -d "$artefacts_root/AU" ]; then
              cp -R "$artefacts_root/AU" "$product_dir/plugin/AU"
            fi
            cat > "$product_dir/plugin/MACOS_LOCAL_DEV_NOTE.txt" <<'EOF'
This build is intended for local development/testing.

If macOS blocks the plugin/app after download ("damaged" or "cannot be opened"),
remove quarantine attributes from installed bundle paths:

xattr -rd com.apple.quarantine ~/Library/Audio/Plug-Ins/Components/YourPlugin.component
xattr -rd com.apple.quarantine ~/Library/Audio/Plug-Ins/VST3/YourPlugin.vst3
sudo xattr -rd com.apple.quarantine /Applications/YourPlugin.app

For public distribution, use proper code signing and notarization.
EOF
            cp build/tests/cpp/plugin_smoke_test "$product_dir/tests/plugin_smoke_test"
            cp build/tests/cpp/wasm_dsp_test "$product_dir/tests/wasm_dsp_test"
            cp build/tests/cpp/moonvst_dsp.aot "$product_dir/tests/moonvst_dsp.aot"
          done

      - name: Upload product artifacts
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-macos-products
          if-no-files-found: error
          path: ci-artifacts/

  build-windows:
    runs-on: windows-latest
    needs: discover-products
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache LLVM deps
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: libs/wamr/core/deps/llvm/build
          key: ${{ runner.os }}-llvm-18.1.8-${{ hashFiles('scripts/setup-windows.ps1') }}
          restore-keys: |
            ${{ runner.os }}-llvm-18.1.8-

      - name: Run Windows setup script
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File scripts/setup-windows.ps1

      - name: Build all products
        shell: pwsh
        run: |
          $products = '${{ needs.discover-products.outputs.products }}' | ConvertFrom-Json
          New-Item -ItemType Directory -Force -Path "ci-artifacts" | Out-Null
          foreach ($product in $products) {
            Write-Host "=== Building product: $product ==="
            $targetSuffix = $product -replace '-', '_'

            if ($product -eq "template") {
              npm run build:dsp
              npm run build:ui
            } else {
              npm run "build:dsp:$product"
              npm run "build:ui:$product"
            }

            cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON -DMOONVST_PRODUCT="$product"
            npm run build:plugin

            $productDir = "ci-artifacts/$product"
            New-Item -ItemType Directory -Force -Path "$productDir/plugin" | Out-Null
            New-Item -ItemType Directory -Force -Path "$productDir/tests" | Out-Null
            Copy-Item "build/plugin/MoonVST_${targetSuffix}_artefacts/Release/VST3" "$productDir/plugin/VST3" -Recurse
            Copy-Item "build/plugin/MoonVST_${targetSuffix}_artefacts/Release/Standalone" "$productDir/plugin/Standalone" -Recurse
            Copy-Item "build/plugin/MoonVST_${targetSuffix}_artefacts/Release/Unity" "$productDir/plugin/Unity" -Recurse
            Copy-Item "build/tests/cpp/Release/plugin_smoke_test.exe" "$productDir/tests/plugin_smoke_test.exe"
            Copy-Item "build/tests/cpp/Release/wasm_dsp_test.exe" "$productDir/tests/wasm_dsp_test.exe"
            Copy-Item "build/tests/cpp/Release/moonvst_dsp.aot" "$productDir/tests/moonvst_dsp.aot"
          }

      - name: Upload product artifacts
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-windows-products
          if-no-files-found: error
          path: ci-artifacts/

  test-artifact-macos:
    runs-on: macos-14
    needs: [discover-products, build-macos]
    steps:
      - name: Download product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-products
          path: products

      - name: Validate and run smoke tests for all products
        shell: bash
        run: |
          set -euo pipefail
          products='${{ needs.discover-products.outputs.products }}'
          for product in $(node -e "const p=JSON.parse(process.argv[1]);console.log(p.join(' '));" "$products"); do
            echo "=== Testing product: $product ==="
            test -d "products/$product/plugin/VST3/${product}.vst3"
            test -x "products/$product/plugin/VST3/${product}.vst3/Contents/MacOS/${product}"
            test -f "products/$product/plugin/Standalone/${product}.app/Contents/MacOS/${product}"
            test -x "products/$product/plugin/Standalone/${product}.app/Contents/MacOS/${product}"
            if [ -d "products/$product/plugin/AU/${product}.component" ]; then
              test -x "products/$product/plugin/AU/${product}.component/Contents/MacOS/${product}"
            fi
            chmod +x "products/$product/tests/wasm_dsp_test" "products/$product/tests/plugin_smoke_test"
            (cd "products/$product/tests" && ./wasm_dsp_test && ./plugin_smoke_test)
          done

  test-artifact-windows:
    runs-on: windows-latest
    needs: [discover-products, build-windows]
    steps:
      - name: Download product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-products
          path: products

      - name: Validate and run smoke tests for all products
        shell: pwsh
        run: |
          $products = '${{ needs.discover-products.outputs.products }}' | ConvertFrom-Json
          foreach ($product in $products) {
            Write-Host "=== Testing product: $product ==="
            if (-not (Test-Path "products/$product/plugin/VST3/$product.vst3")) { throw "VST3 artifact missing for $product" }
            if (-not (Test-Path "products/$product/plugin/Standalone/$product.exe")) { throw "Standalone artifact missing for $product" }
            Push-Location "products/$product/tests"
            & "./wasm_dsp_test.exe"
            if ($LASTEXITCODE -ne 0) { throw "wasm_dsp_test failed with code $LASTEXITCODE for $product" }
            & "./plugin_smoke_test.exe"
            if ($LASTEXITCODE -ne 0) { throw "plugin_smoke_test failed with code $LASTEXITCODE for $product" }
            Pop-Location
          }

  release:
    runs-on: macos-14
    needs: [discover-products, test-artifact-macos, test-artifact-windows]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    steps:
      - name: Validate notarization secrets
        shell: bash
        run: |
          set -euo pipefail
          test -n "${APPLE_ID:-}" || { echo "Missing secret: APPLE_ID"; exit 1; }
          test -n "${APPLE_APP_SPECIFIC_PASSWORD:-}" || { echo "Missing secret: APPLE_APP_SPECIFIC_PASSWORD"; exit 1; }
          test -n "${APPLE_TEAM_ID:-}" || { echo "Missing secret: APPLE_TEAM_ID"; exit 1; }

      - name: Download macOS product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-products
          path: macos-products

      - name: Download Windows product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-products
          path: windows-products

      - name: Prepare default product payload
        shell: bash
        run: |
          set -euo pipefail
          product='${{ needs.discover-products.outputs.default_product }}'
          mkdir -p package/macos package/windows
          cp -R "macos-products/$product/plugin/." package/macos/
          cp -R "windows-products/$product/plugin/." package/windows/
          test -d "package/macos/VST3/${product}.vst3"
          test -f "package/macos/Standalone/${product}.app/Contents/MacOS/${product}"
          test -x "package/macos/VST3/${product}.vst3/Contents/MacOS/${product}"
          test -x "package/macos/Standalone/${product}.app/Contents/MacOS/${product}"
          test -d "package/windows/VST3/${product}.vst3"
          test -f "package/windows/Standalone/${product}.exe"

      - name: Notarize and staple macOS bundles
        shell: bash
        run: |
          set -euo pipefail
          product='${{ needs.discover-products.outputs.default_product }}'
          xcrun notarytool store-credentials moonvst-notary \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"
          ditto -c -k --sequesterRsrc --keepParent package/macos notarize-macos.zip
          xcrun notarytool submit notarize-macos.zip --keychain-profile moonvst-notary --wait
          xcrun stapler staple "package/macos/Standalone/${product}.app"
          xcrun stapler staple "package/macos/VST3/${product}.vst3"
          if [ -d "package/macos/AU/${product}.component" ]; then
            xcrun stapler staple "package/macos/AU/${product}.component"
          fi
          spctl --assess --type execute --verbose=2 "package/macos/Standalone/${product}.app"
          codesign --verify --deep --strict --verbose=2 "package/macos/Standalone/${product}.app"
          codesign --verify --deep --strict --verbose=2 "package/macos/VST3/${product}.vst3"
          if [ -d "package/macos/AU/${product}.component" ]; then
            codesign --verify --deep --strict --verbose=2 "package/macos/AU/${product}.component"
          fi

      - name: Create release archives
        run: |
          tag="${GITHUB_REF_NAME}"
          product="${{ needs.discover-products.outputs.default_product }}"
          (cd package/macos && zip -r "../../moonvst-${tag}-${product}-macos.zip" .)
          (cd package/windows && zip -r "../../moonvst-${tag}-${product}-windows.zip" .)

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-macos.zip
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-windows.zip
