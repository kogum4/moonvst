name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  discover-products:
    runs-on: ubuntu-latest
    outputs:
      products: ${{ steps.discover.outputs.products }}
      default_product: ${{ steps.discover.outputs.default_product }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        shell: bash
        run: |
          products_json="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.length===0){throw new Error('no products found under products/');}process.stdout.write(JSON.stringify(dirs.map((product)=>({product}))))")"
          default_product="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.includes('template')){process.stdout.write('template');}else{process.stdout.write(dirs[0]);}")"
          echo "products=$products_json" >> "$GITHUB_OUTPUT"
          echo "default_product=$default_product" >> "$GITHUB_OUTPUT"
          echo "Discovered products: $products_json"

  build-macos:
    runs-on: macos-14
    needs: discover-products
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-products.outputs.products) }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run macOS setup script
        run: bash scripts/setup-macos.sh

      - name: Build product assets
        shell: bash
        run: |
          set -euo pipefail
          product="${{ matrix.product }}"
          if [ "$product" = "template" ]; then
            npm run build:dsp
            npm run build:ui
          else
            npm run "build:dsp:$product"
            npm run "build:ui:$product"
          fi

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON

      - name: Build plugin
        run: npm run build:plugin

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-macos-${{ matrix.product }}
          path: |
            build/plugin/MoonVST_artefacts/Release/VST3/
            build/plugin/MoonVST_artefacts/Release/Standalone/
            build/plugin/MoonVST_artefacts/Release/AU/
            build/plugin/MoonVST_artefacts/Release/Unity/

      - name: Upload smoke test bundle
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-macos-tests-${{ matrix.product }}
          if-no-files-found: error
          path: |
            build/tests/cpp/plugin_smoke_test
            build/tests/cpp/wasm_dsp_test
            build/tests/cpp/moonvst_dsp.aot

  build-windows:
    runs-on: windows-latest
    needs: discover-products
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-products.outputs.products) }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache LLVM deps
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: libs/wamr/core/deps/llvm/build
          key: ${{ runner.os }}-llvm-18.1.8-${{ hashFiles('scripts/setup-windows.ps1') }}
          restore-keys: |
            ${{ runner.os }}-llvm-18.1.8-

      - name: Run Windows setup script
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File scripts/setup-windows.ps1

      - name: Build product assets
        shell: pwsh
        run: |
          $product = "${{ matrix.product }}"
          if ($product -eq "template") {
            npm run build:dsp
            npm run build:ui
          } else {
            npm run "build:dsp:$product"
            npm run "build:ui:$product"
          }

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON

      - name: Build plugin
        run: npm run build:plugin

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-windows-${{ matrix.product }}
          path: |
            build/plugin/MoonVST_artefacts/Release/VST3/
            build/plugin/MoonVST_artefacts/Release/Standalone/
            build/plugin/MoonVST_artefacts/Release/Unity/
            !build/plugin/MoonVST_artefacts/Release/**/*.lib
            !build/plugin/MoonVST_artefacts/Release/**/*.exp

      - name: Upload smoke test bundle
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-windows-tests-${{ matrix.product }}
          if-no-files-found: error
          path: |
            build/tests/cpp/Release/plugin_smoke_test.exe
            build/tests/cpp/Release/wasm_dsp_test.exe
            build/tests/cpp/Release/moonvst_dsp.aot

  test-artifact-macos:
    runs-on: macos-14
    needs: [discover-products, build-macos]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-products.outputs.products) }}
    steps:
      - name: Download plugin artifact
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-${{ matrix.product }}
          path: package

      - name: Download smoke test bundle
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-tests-${{ matrix.product }}
          path: smoke-tests

      - name: Validate packaged plugin files
        run: |
          test -d package/VST3/MoonVST.vst3
          test -f package/Standalone/MoonVST.app/Contents/MacOS/MoonVST

      - name: Run smoke tests from build artifacts
        working-directory: smoke-tests
        run: |
          chmod +x wasm_dsp_test plugin_smoke_test
          ./wasm_dsp_test
          ./plugin_smoke_test

  test-artifact-windows:
    runs-on: windows-latest
    needs: [discover-products, build-windows]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-products.outputs.products) }}
    steps:
      - name: Download plugin artifact
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-${{ matrix.product }}
          path: package

      - name: Download smoke test bundle
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-tests-${{ matrix.product }}
          path: smoke-tests

      - name: Validate packaged plugin files
        shell: pwsh
        run: |
          if (-not (Test-Path "package/VST3/MoonVST.vst3")) { throw "VST3 artifact missing for ${{ matrix.product }}" }
          if (-not (Test-Path "package/Standalone/MoonVST.exe")) { throw "Standalone artifact missing for ${{ matrix.product }}" }

      - name: Run smoke tests from build artifacts
        working-directory: smoke-tests
        shell: pwsh
        run: |
          & "./wasm_dsp_test.exe"
          if ($LASTEXITCODE -ne 0) { throw "wasm_dsp_test failed with code $LASTEXITCODE for ${{ matrix.product }}" }
          & "./plugin_smoke_test.exe"
          if ($LASTEXITCODE -ne 0) { throw "plugin_smoke_test failed with code $LASTEXITCODE for ${{ matrix.product }}" }

  release:
    runs-on: ubuntu-latest
    needs: [discover-products, test-artifact-macos, test-artifact-windows]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download macOS plugin artifact (default product)
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-${{ needs.discover-products.outputs.default_product }}
          path: package/macos

      - name: Download Windows plugin artifact (default product)
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-${{ needs.discover-products.outputs.default_product }}
          path: package/windows

      - name: Validate release payload
        run: |
          test -d package/macos/VST3/MoonVST.vst3
          test -f package/macos/Standalone/MoonVST.app/Contents/MacOS/MoonVST
          test -d package/windows/VST3/MoonVST.vst3
          test -f package/windows/Standalone/MoonVST.exe

      - name: Create release archives
        run: |
          tag="${GITHUB_REF_NAME}"
          product="${{ needs.discover-products.outputs.default_product }}"
          (cd package/macos && zip -r "../../moonvst-${tag}-${product}-macos.zip" .)
          (cd package/windows && zip -r "../../moonvst-${tag}-${product}-windows.zip" .)

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-macos.zip
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-windows.zip
