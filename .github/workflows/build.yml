name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  discover-products:
    runs-on: ubuntu-latest
    outputs:
      products: ${{ steps.discover.outputs.products }}
      default_product: ${{ steps.discover.outputs.default_product }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        shell: bash
        run: |
          products_json="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.length===0){throw new Error('no products found under products/');}process.stdout.write(JSON.stringify(dirs));")"
          default_product="$(node -e "const fs=require('fs');const dirs=fs.readdirSync('products',{withFileTypes:true}).filter((d)=>d.isDirectory()).map((d)=>d.name).sort();if(dirs.includes('template')){process.stdout.write('template');}else{process.stdout.write(dirs[0]);}")"
          echo "products=$products_json" >> "$GITHUB_OUTPUT"
          echo "default_product=$default_product" >> "$GITHUB_OUTPUT"
          echo "Discovered products: $products_json"

  build-macos:
    runs-on: macos-14
    needs: discover-products
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run macOS setup script
        run: bash scripts/setup-macos.sh

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON

      - name: Build all products
        shell: bash
        run: |
          set -euo pipefail
          products='${{ needs.discover-products.outputs.products }}'
          mkdir -p ci-artifacts
          for product in $(node -e "const p=JSON.parse(process.argv[1]);console.log(p.join(' '));" "$products"); do
            echo "=== Building product: $product ==="
            if [ "$product" = "template" ]; then
              npm run build:dsp
              npm run build:ui
            else
              npm run "build:dsp:$product"
              npm run "build:ui:$product"
            fi
            npm run build:plugin

            product_dir="ci-artifacts/$product"
            mkdir -p "$product_dir/plugin" "$product_dir/tests"
            cp -R build/plugin/MoonVST_artefacts/Release/VST3 "$product_dir/plugin/VST3"
            cp -R build/plugin/MoonVST_artefacts/Release/Standalone "$product_dir/plugin/Standalone"
            cp -R build/plugin/MoonVST_artefacts/Release/Unity "$product_dir/plugin/Unity"
            if [ -d build/plugin/MoonVST_artefacts/Release/AU ]; then
              cp -R build/plugin/MoonVST_artefacts/Release/AU "$product_dir/plugin/AU"
            fi
            cp build/tests/cpp/plugin_smoke_test "$product_dir/tests/plugin_smoke_test"
            cp build/tests/cpp/wasm_dsp_test "$product_dir/tests/wasm_dsp_test"
            cp build/tests/cpp/moonvst_dsp.aot "$product_dir/tests/moonvst_dsp.aot"
          done

      - name: Upload product artifacts
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-macos-products
          if-no-files-found: error
          path: ci-artifacts/

  build-windows:
    runs-on: windows-latest
    needs: discover-products
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache LLVM deps
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: libs/wamr/core/deps/llvm/build
          key: ${{ runner.os }}-llvm-18.1.8-${{ hashFiles('scripts/setup-windows.ps1') }}
          restore-keys: |
            ${{ runner.os }}-llvm-18.1.8-

      - name: Run Windows setup script
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File scripts/setup-windows.ps1

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DMOONVST_ENABLE_UNITY=ON -DBUILD_TESTS=ON

      - name: Build all products
        shell: pwsh
        run: |
          $products = '${{ needs.discover-products.outputs.products }}' | ConvertFrom-Json
          New-Item -ItemType Directory -Force -Path "ci-artifacts" | Out-Null
          foreach ($product in $products) {
            Write-Host "=== Building product: $product ==="
            if ($product -eq "template") {
              npm run build:dsp
              npm run build:ui
            } else {
              npm run "build:dsp:$product"
              npm run "build:ui:$product"
            }
            npm run build:plugin

            $productDir = "ci-artifacts/$product"
            New-Item -ItemType Directory -Force -Path "$productDir/plugin" | Out-Null
            New-Item -ItemType Directory -Force -Path "$productDir/tests" | Out-Null
            Copy-Item "build/plugin/MoonVST_artefacts/Release/VST3" "$productDir/plugin/VST3" -Recurse
            Copy-Item "build/plugin/MoonVST_artefacts/Release/Standalone" "$productDir/plugin/Standalone" -Recurse
            Copy-Item "build/plugin/MoonVST_artefacts/Release/Unity" "$productDir/plugin/Unity" -Recurse
            Copy-Item "build/tests/cpp/Release/plugin_smoke_test.exe" "$productDir/tests/plugin_smoke_test.exe"
            Copy-Item "build/tests/cpp/Release/wasm_dsp_test.exe" "$productDir/tests/wasm_dsp_test.exe"
            Copy-Item "build/tests/cpp/Release/moonvst_dsp.aot" "$productDir/tests/moonvst_dsp.aot"
          }

      - name: Upload product artifacts
        uses: actions/upload-artifact@v4
        with:
          name: moonvst-windows-products
          if-no-files-found: error
          path: ci-artifacts/

  test-artifact-macos:
    runs-on: macos-14
    needs: [discover-products, build-macos]
    steps:
      - name: Download product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-products
          path: products

      - name: Validate and run smoke tests for all products
        shell: bash
        run: |
          set -euo pipefail
          products='${{ needs.discover-products.outputs.products }}'
          for product in $(node -e "const p=JSON.parse(process.argv[1]);console.log(p.join(' '));" "$products"); do
            echo "=== Testing product: $product ==="
            test -d "products/$product/plugin/VST3/MoonVST.vst3"
            test -f "products/$product/plugin/Standalone/MoonVST.app/Contents/MacOS/MoonVST"
            chmod +x "products/$product/tests/wasm_dsp_test" "products/$product/tests/plugin_smoke_test"
            (cd "products/$product/tests" && ./wasm_dsp_test && ./plugin_smoke_test)
          done

  test-artifact-windows:
    runs-on: windows-latest
    needs: [discover-products, build-windows]
    steps:
      - name: Download product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-products
          path: products

      - name: Validate and run smoke tests for all products
        shell: pwsh
        run: |
          $products = '${{ needs.discover-products.outputs.products }}' | ConvertFrom-Json
          foreach ($product in $products) {
            Write-Host "=== Testing product: $product ==="
            if (-not (Test-Path "products/$product/plugin/VST3/MoonVST.vst3")) { throw "VST3 artifact missing for $product" }
            if (-not (Test-Path "products/$product/plugin/Standalone/MoonVST.exe")) { throw "Standalone artifact missing for $product" }
            Push-Location "products/$product/tests"
            & "./wasm_dsp_test.exe"
            if ($LASTEXITCODE -ne 0) { throw "wasm_dsp_test failed with code $LASTEXITCODE for $product" }
            & "./plugin_smoke_test.exe"
            if ($LASTEXITCODE -ne 0) { throw "plugin_smoke_test failed with code $LASTEXITCODE for $product" }
            Pop-Location
          }

  release:
    runs-on: ubuntu-latest
    needs: [discover-products, test-artifact-macos, test-artifact-windows]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download macOS product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-macos-products
          path: macos-products

      - name: Download Windows product artifacts
        uses: actions/download-artifact@v4
        with:
          name: moonvst-windows-products
          path: windows-products

      - name: Prepare default product payload
        shell: bash
        run: |
          set -euo pipefail
          product='${{ needs.discover-products.outputs.default_product }}'
          mkdir -p package/macos package/windows
          cp -R "macos-products/$product/plugin/." package/macos/
          cp -R "windows-products/$product/plugin/." package/windows/
          test -d package/macos/VST3/MoonVST.vst3
          test -f package/macos/Standalone/MoonVST.app/Contents/MacOS/MoonVST
          test -d package/windows/VST3/MoonVST.vst3
          test -f package/windows/Standalone/MoonVST.exe

      - name: Create release archives
        run: |
          tag="${GITHUB_REF_NAME}"
          product="${{ needs.discover-products.outputs.default_product }}"
          (cd package/macos && zip -r "../../moonvst-${tag}-${product}-macos.zip" .)
          (cd package/windows && zip -r "../../moonvst-${tag}-${product}-windows.zip" .)

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-macos.zip
            moonvst-${{ github.ref_name }}-${{ needs.discover-products.outputs.default_product }}-windows.zip
