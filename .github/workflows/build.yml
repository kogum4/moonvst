name: Build

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup WAMR
        run: |
          # Build libiwasm
          cd libs/wamr/product-mini/platforms/darwin
          mkdir -p build && cd build
          cmake .. -DWAMR_BUILD_AOT=1 -DWAMR_BUILD_INTERP=0 -DWAMR_BUILD_LIBC_BUILTIN=1 -DWAMR_BUILD_LIBC_WASI=0
          make -j$(sysctl -n hw.ncpu)

          # Build wamrc
          cd ${{ github.workspace }}/libs/wamr/wamr-compiler
          mkdir -p build && cd build
          cmake ..
          make -j$(sysctl -n hw.ncpu)

      - name: Build DSP
        run: bash scripts/build-dsp.sh

      - name: Install UI dependencies
        run: |
          npm install
          cd ui && npm install

      - name: Build UI
        run: npm run build:ui

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build plugin
        run: cmake --build build --config Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webvst-macos
          path: build/plugin/WebVST_artefacts/Release/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MoonBit
        shell: pwsh
        run: |
          irm https://cli.moonbitlang.com/install/powershell.ps1 | iex
          echo "$env:USERPROFILE\.moon\bin" | Out-File -Append $env:GITHUB_PATH

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install LLVM
        run: choco install llvm -y

      - name: Setup WAMR
        shell: pwsh
        run: |
          # Build iwasm.lib
          cd libs/wamr/product-mini/platforms/windows
          mkdir build -Force; cd build
          cmake .. -DWAMR_BUILD_AOT=1 -DWAMR_BUILD_INTERP=0 -DWAMR_BUILD_LIBC_BUILTIN=1 -DWAMR_BUILD_LIBC_WASI=0
          cmake --build . --config Release

          # Build wamrc
          cd ${{ github.workspace }}/libs/wamr/wamr-compiler
          mkdir build -Force; cd build
          cmake ..
          cmake --build . --config Release

      - name: Build DSP
        shell: pwsh
        run: powershell -File scripts/build-dsp.ps1

      - name: Install UI dependencies
        run: |
          npm install
          cd ui && npm install

      - name: Build UI
        run: npm run build:ui

      - name: Configure plugin
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build plugin
        run: cmake --build build --config Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webvst-windows
          path: build/plugin/WebVST_artefacts/Release/
